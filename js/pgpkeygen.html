<!DOCTYPE html>
<html lang="en">
<head>
    <title>PGP Keygen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="openpgp.min.js"></script>
</head>
<body>
    <h1>PGP Keygen</h1>
    <p>Generate a key set using the following parameters:</p>
    <label for="usernameinp">Username:</label>
    <input type="text" id="usernameinp"><br>
    <label for="emailinp">Email (optional):</label>
    <input type="email" id="emailinp"><br>
    <label for="passphraseinp">Password:</label>
    <input type="password" id="passphraseinp"><br><br>

    <button id="generate" onclick="generateKeys()">Generate keys</button><br>

    <script>
        async function generateKeys() {
            if(window.publicKey) return null; // only generate one key set per session

            const username = document.getElementById("usernameinp").value.trim();
            const email = document.getElementById("emailinp").value.trim();
            const passphrase = document.getElementById("passphraseinp").value.trim();

            const userIDs = [{ name: username || undefined, email: email || undefined }];

            const { privateKey, publicKey, revocationCertificate } = await openpgp.generateKey({
                type: 'ecc',
                curve: 'curve25519',
                userIDs, // Only included if username or email exists
                passphrase: passphrase || undefined, // Only included if passphrase is not empty
                format: 'armored'
            });


            // this is a bit weird sorry
            Object.assign(window, { privateKey, publicKey, revocationCertificate });

            console.log(privateKey);     // '-----BEGIN PGP PRIVATE KEY BLOCK ... '
            console.log(publicKey);      // '-----BEGIN PGP PUBLIC KEY BLOCK ... '
            console.log(revocationCertificate); // '-----BEGIN PGP PUBLIC KEY BLOCK ... '
            
            // i'm aware this is far from the best way to code this but whatever
            const prvKeyElement = createDownloadableFile('prvKeyElement', privateKey, "privateKey");
            const pubKeyElement = createDownloadableFile('pubKeyElement', publicKey, "publicKey");
            const revocElement = createDownloadableFile('revocElement', revocationCertificate, "revocationCertificate");
        }

        function createDownloadableFile(name, data, displayName) {
            const dlElement = document.createElement("a");
            dlElement.id = name;
            dlElement.href = 'data:attachment/text,' + encodeURI(data);
            dlElement.target = '_blank';
            dlElement.download = `${displayName}.asc`;
            dlElement.innerText = `Download ${displayName}.asc`;

            document.body.appendChild(document.createElement("br"));
            document.body.appendChild(dlElement);
            return dlElement;
        }
    </script>
</body>
</html>